---
editor_options:
  chunk_output_type: console
---

# NOTES

-   Alternative pkg names that were considered:

    -   funstate
    -   funst
    -   fnst
    -   fust (has a negative literal meaning)
    -   pkgconf (there's already *pkgconfig*)
    -   pkginit
    -   pkgopt
    -   pkgset
    -   pkgstate (drawback: might evoke associations with [actual state](https://r-pkgs.org/data.html#sec-data-state))
    -   state

-   Existing pkgs with similar functionality:

    -   [config](https://rstudio.github.io/config/)
    -   [fallback](https://github.com/lorenzwalthert/fallback) (great pkg name!)
    -   [GlobalOptions](https://github.com/jokergoo/GlobalOptions)
    -   [pkgconfig](https://github.com/r-lib/pkgconfig) (has a different goal: pkg-local options)
    -   [settings](https://github.com/markvanderloo/settings)

# EXPORTED

## Package configuration values

### `config_val`

```{r}
#' Get package configuration value
#'
#' @description
#' Retrieves a package configuration value in a canonical way. The following configuration sources are consulted in descending order and the first hit is
#' returned:
#'
#' 1. The \R [option][base::options] `<pkg>.<key>`.
#' 2. The [environment variable](https://en.wikipedia.org/wiki/Environment_variable) `R_<PKG>_<KEY>`.
#' 3. The ad-hoc default value specified via this function's `default` argument (`NULL` means unspecified).
#' 4. The configuration's global default value as specified in the package's funky configuration data (column `default_value` or `default_value_dynamic` of
#'    `<pkg>:::funky_config`; `NULL` means unspecified).
#' 
#' Depending on `require`, an error is thrown if none of the above sources contain a value.
#'
#' @details
#' This function is intended to be used by package authors who want to expose their package configuration options in a canonical way (as outlined above). For
#' `config_val()` to properly work, the configuration data must be available in the package's namespace as object `funky_config`, which must be a
#' [dataframe][base::data.frame] with at minimum the columns `key` (of type character holding the configuration key names) and `default_value` (of type list
#' holding static default configuration values) or `default_value_dynamic` (of type character holding R code expressions that evaluate to default configuration
#' values dynamically at access time).
#'
#' @param key Configuration key name. A character scalar.
#' @param pkg `r pkgsnip::param_lbl("pkg")`
#' @param default Default value to fall back to if neither the \R option `<pkg>.<key>` nor the environment variable `R_<PKG>_<KEY>` is set. If `NULL`, the
#'   default value for `key` in `<pkg>:::funky_config` will be used (if defined).
#' @param require Whether or not to require that the configuration value is set. If `TRUE` and no configuration value is set, an error is thrown with
#'   instructions on how to provide a value. If `NULL`, the `require` value for `key` in `<pkg>:::funky_config` will be used (defaults to `TRUE`).
#' @param env Environment to evaluate `default_value_dynamic` in, if necessary.
#'
#' @return `r pkgsnip::return_lbl("r_obj")`
#' @seealso [xfun::env_option()] for a compatible (albeit less powerful) approach to R option and environment variable coherence.
#' @family pkg_config_vals
#' @export
#'
#' @examples
#' try(
#'   funky::config_val(key = "gen_pkgdown_ref",
#'                     pkg = "pkgpurl")
#' )
config_val <- function(key,
                       pkg = utils::packageName(env = parent.frame()),
                       default = NULL,
                       require = NULL,
                       env = parent.frame()) {
  
  checkmate::assert_flag(require,
                         null.ok = TRUE)
  
  funky_config <- config(pkg)
  key <- rlang::arg_match0(key,
                           values = funky_config$key)
  # 1st priority: R option
  result <- getOption(opt_name(key = key,
                               pkg = pkg))
  # 2nd priority: environment variable
  if (is.null(result)) {
    result <- Sys.getenv(env_var_name(key = key,
                                      pkg = pkg),
                         unset = NA,
                         names = FALSE)
  }
  
  # 3rd priority: default value
  if (is.na(result)) {
    result <- default %||% config_val_default(key = key,
                                              pkg = pkg,
                                              env = env)
  }
  
  # abort if value is required but none was provided
  if (is.null(result)) {
    
    if (is.null(require)) {
      require <-
        funky_config |>
        dplyr::filter(key == !!key) |>
        dplyr::pull("require")
    }
    
    if (require) {
      cli::cli_abort(paste0("Please set the {pkg} package configuration option {.field {key}} by either setting the R option ",
                            "{.field {opt_name(key = key, pkg = pkg)}} or the environment variable ",
                            "{.envvar {env_var_name(key = key, pkg = pkg)}}."))
    }
  }
  
  result
}
```

### `config_val_default`

```{r}
#' Get default package configuration value
#'
#' Retrieves a package configuration key's default value from the package's funky configuration data (column `default_value` or `default_value_dynamic` of
#' `<pkg>:::funky_config`). If no default value is specified (`NULL`), nothing is returned (`NULL`).
#'
#' @inheritParams config_val
#'
#' @return `pkgsnip::return_lbl("r_obj")`
#' @family pkg_config_vals
#' @export
#'
#' @examples
#' try(
#'   funky::config_val_default(key = "gen_pkgdown_ref",
#'                             pkg = "pkgpurl")
#' )
config_val_default <- function(key,
                               pkg = utils::packageName(env = parent.frame()),
                               env = parent.frame()) {
  data <- config(pkg)
  key <- rlang::arg_match(arg = key,
                          values = data$key)
  data %<>% dplyr::filter(key == !!key)
  
  if (is.na(data$default_value_dynamic)) {
    
    result <- Reduce(x = data$default_value,
                     f = c)
  } else {
    
    # ensure only one of `default_value_dynamic` and `default_value` is set
    if (!is.null(data$default_value[[1L]])) {
      cli::cli_abort(paste0("Only one of {.var default_value} and {.var default_value_dynamic} can be set in {.var funky_config} for a specific {.var key}, ",
                            "but for {.field {key}} both are."))
    }
    
    result <- eval(expr = parse(text = data$default_value_dynamic),
                   envir = env)
  }
  
  result
}
```

### `has_config_val`

```{r}
#' Test if package configuration value is set
#'
#' Tests whether or not a certain package configuration value is set. See [config_val()] for the underlying concept.
#'
#' Note that `has_config_val()` throws an error if the package configuration *key* doesn't exist.
#'
#' @inheritParams config_val
#'
#' @return A logical scalar.
#' @family pkg_config_vals
#' @export
#'
#' @examples
#' try(
#'   funky::has_config_val(key = "gen_pkgdown_ref",
#'                         pkg = "pkgpurl")
#' )
has_config_val <- function(key,
                           pkg = utils::packageName(env = parent.frame()),
                           env = parent.frame()) {
  
  !is.null(config_val(key = key,
                      pkg = pkg,
                      default = NULL,
                      require = FALSE,
                      env = env))
}
```

## Package configuration data

### `config`

```{r}
#' Package configuration data
#'
#' Retrieves a package's funky configuration data (`<pkg>:::funky_config`).
#'
#' @inheritParams config_val
#'
#' @return `r pkgsnip::param_lbl("tibble_cols", cols = colnames(ptype_funky_config))`
#' @family pkg_config_data
#' @export
#'
#' @examples
#' try(
#'   funky::config(pkg = "pkgpurl")
#' )
config <- function(pkg = utils::packageName(env = parent.frame())) {
  
  checkmate::assert_string(pkg)
  if (!pal::exists_in_namespace(x = "funky_config",
                                ns = pkg)) {
    cli::cli_abort(paste0("Package {.pkg {pkg}} has not defined the required package configuration data in its namespace (as object {.var funky_config}). See ",
                          "the {.emph Details} section of {.help funky::config_val} for more information."))
  }
  
  funky_config <- utils::getFromNamespace(x = "funky_config",
                                          ns = pkg)
  checkmate::assert_data_frame(funky_config,
                               col.names = "unique")
  if (!("key" %in% colnames(funky_config) && any(c("default_value", "default_value_dynamic") %in% colnames(funky_config)))) {
    cli::cli_abort("{.code {pkg}:::funky_config} must at minimum contain the columns {.var key} and {.var default_value} or {.var default_value_dynamic}.")
  }
  
  # ensure/complement df structure
  funky_config |>
    vctrs::tib_cast(to = ptype_funky_config) |>
    tidyr::replace_na(replace = list(require = TRUE))
}
```

### `augment_config`

```{r}
#' Augment package configuration data
#'
#' Augments a package's funky configuration data (`<pkg>:::funky_config`) with the columns `r_opts` and `env_var` holding the respective \R option and
#' environment variable names.
#'
#' @inheritParams config_val
#'
#' @return A [tibble][tibble::tbl_df] with at minimum the columns `key`, `default_value`, `r_opt` and `env_var`.
#' @family pkg_config_data
#' @export
#'
#' @examples
#' try(
#'   funky::augment_config(pkg = "pkgpurl")
#' )
augment_config <- function(pkg = utils::packageName(env = parent.frame())) {
  
  config(pkg) |>
    dplyr::mutate(r_opt = opt_name(key = key,
                                   pkg = pkg),
                  env_var = purrr::map_chr(key,
                                           \(k) env_var_name(key = k,
                                                             pkg = pkg)))
}
```

### `print_config`

NOTES:

-   Column `description` is not mandatory.

```{r}
#' Print package configuration data
#'
#' Prints a package's funky configuration data (`<pkg>:::funky_config`) as a prettily formatted Markdown table.
#'
#' @inheritParams config_val
#' @param roxy_to_md Whether or not to convert roxygen2 documentation [links in pseudo-Markdown
#'   style](https://roxygen2.r-lib.org/articles/rd-formatting.html#function-links) to actual Markdown ones using [pal::roxy_to_md_links()].
#'
#' @inherit pal::pipe_table return
#' @family pkg_config_data
#' @export
#'
#' @examples
#' try(
#'   funky::print_config(pkg = "pkgpurl")
#' )
print_config <- function(pkg = utils::packageName(env = parent.frame()),
                         roxy_to_md = FALSE) {
  
  checkmate::assert_flag(roxy_to_md)
  
  augment_config(pkg) |>
    dplyr::mutate(dplyr::across(c(r_opt, env_var),
                                \(x) pal::wrap_chr(x, wrap = "`")),
                  dplyr::across(any_of("description"),
                                \(x) if (roxy_to_md) purrr::map_chr(x, pal::roxy_to_md_links) else x),
                  default_value = purrr::map2(default_value,
                                              default_value_dynamic,
                                              \(x, y) {
                                                
                                                if (!is.na(y)) {
                                                  return(pal::wrap_chr(y,
                                                                       wrap = "`"))
                                                  
                                                } else if (is.null(x)) {
                                                  return("")
                                                  
                                                } else {
                                                  return(x |>
                                                           constructive::construct(unicode_representation = "unicode",
                                                                                   check = TRUE,
                                                                                   one_liner = TRUE) |>
                                                           purrr::chuck("code") |>
                                                           pal::wrap_chr(wrap = "`"))
                                                }
                                              })) |>
    dplyr::select(any_of("description"),
                  r_opt,
                  env_var,
                  default_value) |>
    dplyr::rename_with(.cols = any_of("description"),
                       .fn = stringr::str_to_title) |>
    dplyr::rename(`R option` = r_opt,
                  `Environment variable` = env_var,
                  `Default value` = default_value) |>
    pal::pipe_table()
}
```

# INTERNAL

## Avoid `R CMD check` NOTES about undefined global objects

cf. <https://github.com/tidyverse/magrittr/issues/29#issuecomment-74313262>

```{r}
utils::globalVariables(names = c(".",
                                 # tidyselect fns
                                 "any_of",
                                 # other
                                 "default_value",
                                 "default_value_dynamic",
                                 "env_var",
                                 "key",
                                 "r_opt"))
```

## Functions

### `env_var_name`

```{r}
#' Assemble environment variable name
#'
#' Assembles the environment variable name for a given package configuration key.
#'
#' @inheritParams config_val
#'
#' @returns A character scalar.
#' @keywords internal
#'
#' @examples
#' funky:::env_var_name(key = "gen_pkgdown_ref",
#'                      pkg = "pkgpurl")
env_var_name <- function(key,
                         pkg = utils::packageName(env = parent.frame())) {
  
  pal::as_env_var_name("R", pkg, key)
}
```

### `opt_name`

```{r}
#' Assemble \R option name
#'
#' Assembles the \R option name for a given package configuration key.
#'
#' @inheritParams config_val
#'
#' @returns A character scalar.
#' @keywords internal
#'
#' @examples
#' funky:::opt_name(key = "gen_pkgdown_ref",
#'                  pkg = "pkgpurl")
opt_name <- function(key,
                     pkg) {
  paste(pkg, key,
        sep = ".")
}
```

## Constants

### `ptype_funky_config`

```{r}
ptype_funky_config <- tibble::tibble(key = character(),
                                     default_value = list(),
                                     default_value_dynamic = character(),
                                     require = logical(),
                                     description = character())
```
